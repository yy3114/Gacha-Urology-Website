<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³Œå°¿å¥åº·æ‰­è›‹æ©Ÿ v1</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* æ·ºè—ç°è‰²èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 10vh; /* ä¿®æ­£ç‚ºvhä»¥é©æ‡‰è¡Œå‹•è£ç½® */
            padding: 20px;
        }
        /* æ‰­è›‹æ©Ÿç«‹é«”åŒ– */
        .gacha-machine {
            background-color: #c02a2a; /* æ›´æ·±çš„ç´…è‰²åŸºåº• */
            box-shadow: 0 40px 50px rgba(0, 0, 0, 0.3), inset 0 -10px 10px rgba(160, 20, 20, 0.5); 
            transition: transform 0.3s ease;
        }
        .gacha-machine:hover {
            transform: translateY(-5px);
        }
        /* æ‰­è›‹æ©Ÿçš„ã€Œç»ç’ƒã€éƒ¨åˆ† - å¢åŠ å…§é™°å½±ä»¥ç¤ºæ·±åº¦ */
        .gacha-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(3px);
            border: 5px solid #a01010; /* æ›´æ·±çš„ç´…è‰²é‚Šæ¡† */
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2); /* å…§é™°å½±å¢åŠ æ·±åº¦ */
            overflow: hidden; 
        }
        
        /* æŠŠæ‰‹è½‰å‹•å‹•ç•«ï¼šé †æ™‚é˜å…©åœˆ (720åº¦) - é€Ÿåº¦æ¸›æ…¢è‡³ 1.5s */
        .knob-turning-full {
            animation: fullTurn 1.5s ease-out forwards; 
        }
        @keyframes fullTurn {
            from { transform: rotate(0deg); }
            to { transform: rotate(720deg); } 
        }

        /* æ‰­è›‹å½ˆå‡ºçš„å‹•ç•« (ç”¨æ–¼ 1.5s å»¶é²å¾Œå½ˆå‡ºæ•ˆæœ) */
        .prize-out {
            /* åŠ å…¥ transform çš„éæ¸¡æ™‚é–“ï¼Œä½¿å…¶åœ¨æ—‹è½‰æ™‚ä¹Ÿèƒ½å¹³æ»‘å‡ºç¾ */
            animation: prizeFall 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes prizeFall {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* è† å›Šæ¨£å¼ - åœ¨çƒæ± ä¸­ */
        .capsule {
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; 
            color: white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.4); 
            position: absolute; 
            opacity: 0.9; 
            z-index: 1; 
            border: 2px solid rgba(255, 255, 255, 0.5);
            /* é—œéµï¼šè®“æ‰€æœ‰ capsule çš„ä½ç½®è®ŠåŒ–å¹³æ»‘éæ¸¡ */
            transition: all 0.5s ease-in-out; 
        }
        /* æ‰­è›‹çƒæ± å®¹å™¨ */
        .capsule-pool {
            position: absolute;
            inset: 0;
            padding: 10px;
        }

        /* ------------------------------------- */
        /* çå“å‡ºå£æ”¹ç‚ºç«‹é«”å‡¹æ§½ */
        #prize-chute-container {
            width: 100px; 
            height: 100px; 
            border-radius: 12px; 
            background-color: #1f2937; 
            padding: 5px; 
            box-shadow: inset 0 5px 10px rgba(0, 0, 0, 0.5), 0 5px 10px rgba(0, 0, 0, 0.2); 
            transform: perspective(100px) rotateX(10deg); 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* å‡¹æ§½å…§éƒ¨ï¼Œç”¨æ–¼æ”¾ç½®è† å›Šçƒ */
        #prize-chute {
            width: 70px; 
            height: 70px;
            background-color: #374151; /* å‡¹æ§½å…§å´é¡è‰² */
            border-radius: 10px; 
            border: 2px solid #555;
            transition: all 0.3s ease;
            cursor: default; 
            font-size: 0; 
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        #prize-chute:not([disabled]) {
            cursor: pointer;
        }

        /* ------------------------------------- */
        /* æŠ•å¹£å£æ”¹ç‚ºå°ç´°é•·æ–¹å½¢ */
        #coin-button {
            width: 1rem; /* æ¥µçª„åŒ– */
            height: 3rem; 
            background-color: #374151; /* åŸºç¤è‰²ç‚ºæ·±ç°/é»‘ */
            border-radius: 0.25rem; 
            border: 2px solid #1f2937;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5); 
            font-size: 0; 
            transition: all 0.15s ease;
        }

        /* æŠ•å¹£å£å‹•ç•« (æº–å‚™ç‹€æ…‹) */
        .coin-ready-flash {
            animation: pulseCoin 1.5s infinite alternate; /* æ…¢é€Ÿäº¤æ›¿é–ƒçˆ */
        }
        @keyframes pulseCoin {
            0% { background-color: #374151; } /* æ·±è‰²é–‹å§‹ */
            100% { background-color: #fcd34d; } /* äº®é»ƒè‰²é–ƒçˆ */
        }
        
        /* æŠ•å¹£å£å‹•ç•« (æ’å…¥ç¬é–“) */
        .coin-inserted-flash {
            background-color: #fcd34d !important; /* æ’å…¥ç¬é–“äº®é»ƒè‰² */
            transition: background-color 0.1s ease-in-out;
        }
        
        /* è† å›Šçƒå‡ºç¾æ™‚çš„æ¨£å¼ (å–ä»£ prize-chute å…§å®¹) */
        .capsule-in-chute {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            /* è®“èƒŒæ™¯è‰²å’Œé™°å½±æ­£ç¢ºé¡¯ç¤º */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), inset 0 0 8px rgba(255, 255, 255, 0.5);
            font-size: 1.5rem !important;
            color: white !important;
            background-color: transparent !important; /* é˜²æ­¢è¢«è¦†è“‹ */
            border: 2px solid rgba(255, 255, 255, 0.8) !important;
            transition: all 0.3s ease, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¢åŠ  transform éæ¸¡ */
        }

        /* è‡ªå®šç¾© Modal æ¨£å¼ */
        #custom-modal > div {
            transition: transform 0.3s ease-out;
        }
        .scale-100 {
            transform: scale(1) !important;
        }
    </style>
</head>
<body>

<div class="p-4 w-full max-w-4xl flex flex-col lg:flex-row gap-8">

    <!-- æ‰­è›‹æ©Ÿæœ¬é«” (å·¦å´/ä¸Šå´) -->
    <div class="gacha-machine w-full lg:w-1/2 mx-auto rounded-2xl p-4 flex flex-col items-center">
        <!-- æ¨™é¡Œèª¿æ•´ï¼šv1 ç¸®å° -->
        <h1 class="text-3xl font-bold text-white mb-4 shadow-sm">æ³Œå°¿å¥åº·æ‰­è›‹æ©Ÿ <span class="text-xl font-normal">v1</span></h1>
        
        <!-- æ‰­è›‹å±•ç¤ºå€ (é€æ˜åœ“ç­’) -->
        <div class="gacha-container w-full h-64 rounded-xl border-4 border-gray-700 p-2 relative">
            
            <!-- æ©Ÿå°ç‹€æ…‹æç¤º (ä¸Šç§») -->
            <div class="absolute text-center text-gray-700 font-semibold z-20 top-4 left-1/2 transform -translate-x-1/2 status-display">
                <p id="machine-status" class="text-xl text-gray-800">è«‹å…ˆæŠ•å…¥é‡‘å¹£ (1/1)</p>
                <div id="audio-status" class="text-xs text-gray-500 mt-1">é¦–æ¬¡äº’å‹•å¾ŒéŸ³æ•ˆå°‡å•Ÿç”¨ ğŸ”Š</div>
                <div id="loading-spinner" class="hidden animate-spin rounded-full h-8 w-8 border-b-2 border-red-700 mt-2 mx-auto"></div>
            </div>

            <!-- æ‰­è›‹çƒæ± ï¼šç”± JavaScript å‹•æ…‹ç”Ÿæˆå’Œç§»é™¤ -->
            <div class="capsule-pool" id="capsule-pool">
                <!-- è† å›Šçƒå°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æŠ•å¹£/è½‰å‹•æ©Ÿæ§‹ (ç´…è‰²çš„æ©Ÿèº«ä¸‹åŠéƒ¨) -->
        <div class="w-full bg-red-800 p-4 mt-4 rounded-xl flex justify-around items-center border-t-4 border-gray-700 relative">
            
            <!-- æŠ•å¹£å£ (å·¦å´) - æ¥µçª„åŒ– -->
            <div class="flex flex-col items-center absolute left-6 top-1/2 transform -translate-y-1/2 coin-status-container">
                <button id="coin-button" onclick="insertCoin()" class="hover:opacity-80 transition duration-150 active:scale-95 disabled:opacity-80">
                    <!-- ç©ºç™½å…§å®¹ï¼Œç”± CSS æ±ºå®šå°ºå¯¸å’Œå½¢ç‹€ -->
                </button>
                <p id="coin-status" class="text-sm text-yellow-300 mt-1">æŠ•å…¥é‡‘å¹£</p>
            </div>
            
            <!-- è½‰å‹•æŠŠæ‰‹ (ä¸­é–“) -->
            <button id="knob-button" onclick="pullLever()" class="mx-auto relative bg-gray-800 p-2 rounded-full cursor-pointer hover:bg-gray-900 transition duration-150 active:scale-95 disabled:opacity-50" disabled>
                <div id="knob" class="w-12 h-12 bg-gray-500 rounded-full flex items-center justify-center transition duration-150">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                </div>
            </button>
        </div>

        <!-- çå“å‡ºå£ (ç«‹é«”å‡¹æ§½) -->
        <div class="w-full flex justify-center -mt-4">
            <div id="prize-chute-container" class="mt-4">
                <!-- çå“å‡ºå£æŒ‰éˆ• (å‡¹æ§½å…§éƒ¨/è† å›Šçƒå‡ºç¾ä½ç½®) -->
                <button id="prize-chute" disabled>
                    <!-- é è¨­ç„¡å…§å®¹ -->
                </button>
            </div>
        </div>

    </div>

    <!-- æŠ½ççµæœèˆ‡æ”¶è— (å³å´/ä¸‹å´) -->
    <div class="w-full lg:w-1/2 bg-white rounded-2xl p-6 shadow-xl">
        <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">æˆ‘çš„å¥åº·æ”¶è—</h2>

        <!-- æœ€æ–°æŠ½ççµæœé¡¯ç¤ºå€ -->
        <div class="mb-6 border-2 border-dashed border-red-300 p-4 rounded-lg">
            <h3 class="text-xl font-semibold text-red-600 mb-2">æœ€æ–°æŠ½çï¼š</h3>
            <div id="latest-prize-display" class="min-h-[80px] flex flex-col justify-center items-start">
                <p class="text-gray-500">å°šç„¡æœ€æ–°çå“ã€‚</p>
            </div>
        </div>

        <!-- æ”¶è—æ¸…å–® -->
        <div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">æ‰€æœ‰æ”¶è— (<span id="total-prizes">0</span> å€‹):</h3>
            <div id="prize-collection" class="max-h-60 overflow-y-auto space-y-3 p-2 bg-gray-50 rounded-lg">
                <p id="loading-message" class="text-sm text-gray-500">æ­£åœ¨è¼‰å…¥æ”¶è—æ•¸æ“š...</p>
            </div>
        </div>

        <!-- èªè­‰è¨Šæ¯ -->
        <p class="mt-6 text-xs text-gray-400">
            ç”¨æˆ¶ ID: <span id="user-id-display">è¼‰å…¥ä¸­...</span>
            <span id="auth-status" class="ml-2 font-medium text-blue-500"></span>
        </p>
    </div>
</div>

<script type="module">
    // å¼•å…¥ Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // å¼•å…¥ Tone.js åº« (ç”¨æ–¼éŸ³æ•ˆ)
    import * as Tone from "https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js";

    // è¨­å®š Firebase Log ç­‰ç´š (é™¤éŒ¯ç”¨)
    setLogLevel('debug');

    // å–å¾—ç’°å¢ƒè®Šæ•¸
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹è®Šæ•¸
    let db, auth;
    let userId = 'loading'; 
    let isAuthReady = false;
    let hasCoin = false; 
    let currentPrize = null; 
    let isAudioActive = false; 

    // DOM å…ƒç´ 
    const knobButton = document.getElementById('knob-button');
    const knob = document.getElementById('knob');
    const machineStatus = document.getElementById('machine-status');
    const loadingSpinner = document.getElementById('loading-spinner');
    const prizeChute = document.getElementById('prize-chute');
    const latestPrizeDisplay = document.getElementById('latest-prize-display');
    const prizeCollectionEl = document.getElementById('prize-collection');
    const totalPrizesEl = document.getElementById('total-prizes');
    const userIdDisplay = document.getElementById('user-id-display');
    const authStatusEl = document.getElementById('auth-status');
    const coinButton = document.getElementById('coin-button');
    const coinStatus = document.getElementById('coin-status');
    const audioStatusEl = document.getElementById('audio-status');
    const capsulePoolEl = document.getElementById('capsule-pool');


    // Tone.js éŸ³æ•ˆè¨­å®š
    let synth = null;
    let noiseSynth = null; 

    // æ³Œå°¿ç§‘ä¸»é¡Œçå“æ¸…å–® (å«å½©è›‹)
    const prizes = [
        { id: 1, name: 'è†€èƒ±å›çš„è²¼å¿ƒæé†’', icon: 'ğŸ’§', color: 'bg-blue-500', base_color: '#3b82f6', description: 'ä¿æŒæ°´åˆ†å……è¶³ï¼Œæ·±é»ƒè‰²å°¿æ¶²æ˜¯è­¦è¨Šï¼å¤šå–æ°´ï¼Œä½ çš„è†€èƒ±å›æœƒæ„Ÿè¬ä½ ã€‚' },
        { id: 2, name: 'è…è‡Ÿè¶…äººçš„é é˜²ç§˜è¨£', icon: 'ğŸ’', color: 'bg-yellow-500', base_color: '#f59e0b', description: 'é¿å…é«˜éˆ‰é£²é£Ÿï¼Œå¹«åŠ©è…è‡Ÿè¶…äººé é›¢çµçŸ³å±æ©Ÿã€‚' },
        { id: 3, name: 'å‰åˆ—è…ºå®ˆè­·è€…çš„å•å€™', icon: 'ğŸ›¡ï¸', color: 'bg-red-500', base_color: '#ef4444', description: '50æ­²ä»¥ä¸Šçš„ç”·æ€§ï¼Œå®šæœŸæª¢æŸ¥æ˜¯é—œéµï¼é—œå¿ƒå‰åˆ—è…ºå¥åº·ã€‚' },
        { id: 4, name: 'æ³Œå°¿é“å¥åº·å¡', icon: 'ğŸš½', color: 'bg-green-500', base_color: '#22c55e', description: 'ä¸è¦æ†‹å°¿ï¼æ¯æ¬¡ä¸Šå»æ‰€éƒ½æ˜¯å°æ³Œå°¿é“æœ€å¥½çš„ä¿è­·ã€‚' },
        { id: 5, name: 'å¥åº·é»ƒé‡‘æ³•å‰‡', icon: 'âœ¨', color: 'bg-purple-500', base_color: '#a855f7', description: 'è¦å¾‹é‹å‹•ï¼Œç¶­æŒæ­£å¸¸é«”é‡ï¼Œå°æ•´é«”æ³Œå°¿ç³»çµ±éƒ½æœ‰ç›Šè™•ã€‚' },
        { id: 6, name: 'å’–å•¡å› èˆ‡èŒ¶çš„å¹³è¡¡', icon: 'â˜•', color: 'bg-indigo-500', base_color: '#6366f1', description: 'éé‡å’–å•¡å› å’ŒèŒ¶é¡å¯èƒ½åˆºæ¿€è†€èƒ±ï¼Œé©åº¦å°±å¥½ï¼' },
        // å½©è›‹çå“ (ID 7)
        { id: 7, name: 'å¥é”å¥‡è¶£è›‹', icon: 'ğŸ«', color: 'bg-pink-300', base_color: '#f9a8d4', description: 'æ­å–œï¼é€™æ˜¯æ©Ÿç‡è¶…ä½çš„å½©è›‹çå“ï¼å¸Œæœ›è£¡é¢æ˜¯å¥½ç©çš„ç©å…·ï¼' },
    ];
    
    // è† å›Šçƒæ± çš„éœæ…‹ä½ç½®æ•¸æ“š (åŒ…å«å°‘é‡çš„å½©è›‹)
    let capsulePoolData = [
        // åº•éƒ¨ç¬¬ä¸€å±¤ (80% - 90% top)
        { color: 'linear-gradient(135deg, #38bdf8 50%, #0369a1 50%)', icon: 'ğŸ’§', left: 3, top: 80, rotate: 10, z: 10 },
        { color: 'linear-gradient(135deg, #facc15 50%, #b45309 50%)', icon: 'ğŸ’', left: 13, top: 75, rotate: -5, z: 12 },
        { color: 'linear-gradient(135deg, #f43f5e 50%, #9f1239 50%)', icon: 'ğŸ›¡ï¸', left: 25, top: 85, rotate: 25, z: 15 },
        { color: 'linear-gradient(135deg, #10b981 50%, #065f46 50%)', icon: 'ğŸš½', left: 40, top: 78, rotate: -15, z: 11 },
        { color: 'linear-gradient(135deg, #a855f7 50%, #6d28d9 50%)', icon: 'âœ¨', left: 55, top: 88, rotate: 40, z: 14 },
        { color: 'linear-gradient(135deg, #6366f1 50%, #3730a3 50%)', icon: 'â˜•', left: 70, top: 82, rotate: 0, z: 13 },
        { color: 'linear-gradient(135deg, #fb7185 50%, #be123c 50%)', icon: 'ğŸ’§', left: 85, top: 75, rotate: 18, z: 11 },
        { color: 'linear-gradient(135deg, #2563eb 50%, #1e3a8a 50%)', icon: 'ğŸ’', left: 5, top: 90, rotate: -25, z: 16 }, 
        // ç¨€æœ‰å½©è›‹ 1
        { color: 'linear-gradient(135deg, #f9a8d4 50%, #db2777 50%)', icon: 'ğŸ«', left: 90, top: 80, rotate: 35, z: 15 }, 

        // ä¸­å±¤ (60% - 75% top)
        { color: 'linear-gradient(135deg, #06b6d4 50%, #0e7490 50%)', icon: 'ğŸ’', left: 8, top: 60, rotate: -22, z: 14 },
        { color: 'linear-gradient(135deg, #4ade80 50%, #16a34a 50%)', icon: 'ğŸ›¡ï¸', left: 30, top: 68, rotate: 5, z: 10 },
        { color: 'linear-gradient(135deg, #ffedd5 50%, #fef3c7 50%)', icon: 'ğŸš½', left: 55, top: 65, rotate: 30, z: 15, text_color: '#6d28d9' },
        { color: 'linear-gradient(135deg, #ef4444 50%, #b91c1c 50%)', icon: 'âœ¨', left: 75, top: 70, rotate: -5, z: 12 },
        { color: 'linear-gradient(135deg, #3b82f6 50%, #1d4ed8 50%)', icon: 'â˜•', left: 88, top: 60, rotate: 15, z: 13 },
        { color: 'linear-gradient(135deg, #10b981 50%, #065f46 50%)', icon: 'ğŸ’§', left: 45, top: 70, rotate: 10, z: 14 }, 
        { color: 'linear-gradient(135deg, #a78bfa 50%, #6d28d9 50%)', icon: 'â˜•', left: 20, top: 62, rotate: -18, z: 11 }, 
        
        // ä¸­é«˜å±¤ (40% - 58% top)
        { color: 'linear-gradient(135deg, #facc15 50%, #b45309 50%)', icon: 'ğŸ’§', left: 0, top: 48, rotate: 70, z: 10 },
        { color: 'linear-gradient(135deg, #a78bfa 50%, #6d28d9 50%)', icon: 'ğŸ’', left: 20, top: 55, rotate: -10, z: 11 },
        { color: 'linear-gradient(135deg, #f43f5e 50%, #9f1239 50%)', icon: 'ğŸ›¡ï¸', left: 45, top: 58, rotate: 50, z: 14 },
        { color: 'linear-gradient(135deg, #10b981 50%, #065f46 50%)', icon: 'ğŸš½', left: 15, top: 40, rotate: -30, z: 10 },
        { color: 'linear-gradient(135deg, #f97316 50%, #c2410c 50%)', icon: 'âœ¨', left: 68, top: 50, rotate: 20, z: 11 },
        { color: 'linear-gradient(135deg, #3b82f6 50%, #1d4ed8 50%)', icon: 'â˜•', left: 80, top: 45, rotate: -10, z: 13 },
        { color: 'linear-gradient(135deg, #fb7185 50%, #be123c 50%)', icon: 'ğŸ’§', left: 95, top: 40, rotate: 5, z: 14 },
        { color: 'linear-gradient(135deg, #06b6d4 50%, #0e7490 50%)', icon: 'ğŸ’', left: 35, top: 48, rotate: -15, z: 12 },
        { color: 'linear-gradient(135deg, #4ade80 50%, #16a34a 50%)', icon: 'ğŸ›¡ï¸', left: 58, top: 40, rotate: 45, z: 15 }, 
        { color: 'linear-gradient(135deg, #facc15 50%, #b45309 50%)', icon: 'ğŸš½', left: 85, top: 55, rotate: -20, z: 10 }, 
        
        // é ‚å±¤é»ç¶´ (30% - 35% top)
        { color: 'linear-gradient(135deg, #a78bfa 50%, #6d28d9 50%)', icon: 'âœ¨', left: 25, top: 30, rotate: 15, z: 9 },
        { color: 'linear-gradient(135deg, #4ade80 50%, #16a34a 50%)', icon: 'ğŸ›¡ï¸', left: 60, top: 35, rotate: -20, z: 9 },
        // ç¨€æœ‰å½©è›‹ 2
        { color: 'linear-gradient(135deg, #f9a8d4 50%, #db2777 50%)', icon: 'ğŸ«', left: 10, top: 35, rotate: 30, z: 8 }, 
        { color: 'linear-gradient(135deg, #3b82f6 50%, #1d4ed8 50%)', icon: 'ğŸ’', left: 75, top: 30, rotate: -5, z: 8 }, 
        { color: 'linear-gradient(135deg, #f97316 50%, #c2410c 50%)', icon: 'â˜•', left: 40, top: 35, rotate: 10, z: 7 }, 
    ];


    /**
     * è‡ªè¨‚å½ˆå‡ºè¦–çª—å–ä»£ alert()
     */
    function alertModal(message) {
        // å°‹æ‰¾ç¾æœ‰çš„ modal æˆ–å‰µå»ºä¸€å€‹æ–°çš„
        let modal = document.getElementById('custom-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4 transform scale-95 transition-transform duration-300">
                    <p id="modal-message" class="text-gray-800 font-semibold mb-4"></p>
                    <button onclick="document.getElementById('custom-modal').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('custom-modal').querySelector('div').classList.remove('scale-100');" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">
                        ç¢ºå®š
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById('modal-message').textContent = message;
        
        // é¡¯ç¤º modal
        setTimeout(() => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.add('scale-100');
        }, 10);
    }
    window.alertModal = alertModal; // è®“å®ƒèƒ½åœ¨ HTML å…§èª¿ç”¨


    /**
     * å‹•æ…‹æ¸²æŸ“è† å›Šçƒæ± 
     */
    function renderCapsulePool() {
        capsulePoolEl.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
        capsulePoolData.forEach(data => {
            const capsule = document.createElement('span');
            capsule.className = 'capsule';
            capsule.innerHTML = data.icon;
            capsule.style.cssText = `
                background: ${data.color};
                left: ${data.left}%;
                top: ${data.top}%;
                transform: rotate(${data.rotate}deg);
                z-index: ${data.z};
                ${data.text_color ? `color: ${data.text_color};` : ''}
            `;
            capsulePoolEl.appendChild(capsule);
        });
    }

    /**
     * åˆå§‹åŒ– Tone.js
     */
    function initTone() {
        if (isAudioActive) return;
        try {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { release: 0.1, attack: 0.005 }
            }).toDestination();
            
            noiseSynth = new Tone.NoiseSynth({
                noise: { type: "white" },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
            }).toDestination();

            isAudioActive = true;
            audioStatusEl.textContent = 'éŸ³æ•ˆå·²å•Ÿç”¨ âœ…';

        } catch (e) {
            console.warn("Tone.js åˆå§‹åŒ–å¤±æ•—:", e);
            audioStatusEl.textContent = 'éŸ³æ•ˆç„¡æ³•å•Ÿç”¨ âŒ';
        }
    }

    /**
     * æ’­æ”¾éŸ³æ•ˆ
     */
    function playSFX(type) {
        if (!isAudioActive) return;
        try {
            switch (type) {
                case 'coin':
                    synth.triggerAttackRelease("C5", "8n");
                    break;
                case 'turn':
                    noiseSynth.triggerAttackRelease("16n", Tone.now(), 0.3); 
                    break;
                case 'drop':
                    synth.triggerAttackRelease(["G4", "C4"], "16n", Tone.now(), 0.8);
                    break;
            }
        } catch (e) {
            console.warn("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e);
        }
    }


    /**
     * å•Ÿå‹• Firestore å¯¦æ™‚ç›£è½
     */
    function listenToPrizes(currentUserId) {
        if (!db || !currentUserId) return;
        
        // Firestore ç§æœ‰è³‡æ–™è·¯å¾‘: /artifacts/{appId}/users/{userId}/urology_gacha/prizes
        const prizeDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'urology_gacha', 'prizes');
        
        // é–‹å§‹ç›£è½æ–‡ä»¶
        onSnapshot(prizeDocRef, (docSnap) => {
            prizeCollectionEl.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) loadingMessage.remove(); // ç§»é™¤è¼‰å…¥ä¸­è¨Šæ¯

            if (docSnap.exists()) {
                const data = docSnap.data();
                const prizesArray = data.collectedPrizes || [];
                
                // ç”±æ–¼ Firestore ä¸æ”¯æ´ orderByï¼Œæˆ‘å€‘åœ¨å®¢æˆ¶ç«¯é€²è¡Œæ™‚é–“æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
                prizesArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                totalPrizesEl.textContent = prizesArray.length;
                
                if (prizesArray.length === 0) {
                    prizeCollectionEl.innerHTML = '<p class="text-sm text-gray-500 italic">é‚„æ²’æœ‰ä»»ä½•æ”¶è—ã€‚è©¦è‘—æ‰­ä¸€å€‹å§ï¼</p>';
                } else {
                    prizesArray.forEach((prizeEntry, index) => {
                        // å°‹æ‰¾çå“ç´°ç¯€
                        const prizeDetail = prizes.find(p => p.id === prizeEntry.id) || { name: 'æœªçŸ¥çå“', icon: 'â“', color: 'bg-gray-400' };

                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-2 bg-white rounded-lg shadow-sm';
                        item.innerHTML = `
                            <span class="text-2xl" style="color: ${prizeDetail.base_color};">${prizeDetail.icon}</span>
                            <div class="flex-grow">
                                <p class="font-medium text-gray-700">${prizeDetail.name} ${prizeDetail.id === 7 ? '<span class="text-xs text-pink-600 font-bold ml-1">(å½©è›‹)</span>' : ''}</p>
                                <p class="text-xs text-gray-400">${new Date(prizeEntry.timestamp).toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'medium' })}</p>
                            </div>
                        `;
                        prizeCollectionEl.appendChild(item);
                    });
                }
            } else {
                // æ–‡ä»¶ä¸å­˜åœ¨ (ç”¨æˆ¶ç¬¬ä¸€æ¬¡ä½¿ç”¨)
                totalPrizesEl.textContent = 0;
                prizeCollectionEl.innerHTML = '<p class="text-sm text-gray-500 italic">é‚„æ²’æœ‰ä»»ä½•æ”¶è—ã€‚è©¦è‘—æ‰­ä¸€å€‹å§ï¼</p>';
            }
        }, (error) => {
            console.error("Firestore ç›£è½å¤±æ•—:", error);
            alertModal("éŒ¯èª¤ï¼šç„¡æ³•å³æ™‚æ›´æ–°æ‚¨çš„æ”¶è—åˆ—è¡¨ã€‚");
        });
    }

    /**
     * åˆå§‹åŒ– Firebase å’Œèº«ä»½é©—è­‰
     */
    async function initFirebase() {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase é…ç½®éºå¤±ã€‚æ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•å„²å­˜è³‡æ–™ã€‚");
            authStatusEl.textContent = 'æœªé€£ç·š (ç„¡é…ç½®)';
            isAuthReady = true;
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // è™•ç†èº«ä»½é©—è­‰
            if (initialAuthToken) {
                // ä½¿ç”¨è‡ªè¨‚ Token ç™»å…¥ (Canvas ç’°å¢ƒ)
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // åŒ¿åç™»å…¥ (é Canvas ç’°å¢ƒçš„å‚™ç”¨æ–¹æ¡ˆ)
                await signInAnonymously(auth);
            }

            // è¨­ç½®èº«ä»½é©—è­‰ç‹€æ…‹ç›£è½å™¨
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    authStatusEl.textContent = 'å·²é©—è­‰';
                    isAuthReady = true;
                    // é©—è­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                    listenToPrizes(userId);
                } else {
                    // é€™æ‡‰è©²åªç™¼ç”Ÿåœ¨æ²’æœ‰ custom token ä¸” signInAnonymously æˆåŠŸçš„æƒ…æ³ä¸‹
                    userId = 'anonymous_user'; 
                    userIdDisplay.textContent = userId + ' (åŒ¿å)';
                    authStatusEl.textContent = 'åŒ¿åæ¨¡å¼';
                    isAuthReady = true;
                    listenToPrizes(userId); 
                }
            });

        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–æˆ–ç™»å…¥å¤±æ•—:", error);
            userId = 'error';
            userIdDisplay.textContent = 'éŒ¯èª¤!';
            authStatusEl.textContent = 'é€£ç·šå¤±æ•—';
            isAuthReady = true;
            alertModal(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
        }
    }


    /**
     * è™•ç†æŠ•å…¥é‡‘å¹£äº‹ä»¶
     */
    window.insertCoin = function() {
        initTone();
        if (!isAuthReady) {
            alertModal('é€£ç·šæº–å‚™ä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚');
            return;
        }
        
        if (hasCoin) {
            alertModal('æ‚¨å·²ç¶“æŠ•å…¥é‡‘å¹£äº†ï¼è«‹è½‰å‹•æŠŠæ‰‹ã€‚');
            return;
        }

        hasCoin = true;
        knobButton.disabled = false; 
        coinButton.disabled = true; // ç«‹å³ç¦ç”¨æŒ‰éˆ•

        // ç§»é™¤é–ƒçˆç‹€æ…‹
        coinButton.classList.remove('coin-ready-flash');
        
        // å•Ÿç”¨æ’å…¥ç¬é–“çš„å‹•ç•«/é¡è‰²
        coinButton.classList.add('coin-inserted-flash');
        coinStatus.textContent = 'é‡‘å¹£å·²æŠ•å…¥';
        machineStatus.textContent = 'é‡‘å¹£å·²æŠ•å…¥ï¼è«‹è½‰å‹•æŠŠæ‰‹ã€‚';
        playSFX('coin'); 
        
        // ç¬é–“å‹•ç•«çµæŸå¾Œï¼Œåˆ‡æ›å›æ·±ç°é»‘è‰² (Inactive/Used look)
        setTimeout(() => {
            coinButton.classList.remove('coin-inserted-flash');
            // CSS å·²ç¶“å°‡åŸºç¤è‰²è¨­ç‚º #374151 (æ·±ç°é»‘)
        }, 150);
    }

    /**
     * è™•ç†è½‰å‹•æŠŠæ‰‹äº‹ä»¶
     */
    window.pullLever = async function() {
        if (!hasCoin) {
            alertModal('è«‹å…ˆæŠ•å…¥é‡‘å¹£ ($) æ‰èƒ½è½‰å‹•æŠŠæ‰‹ï¼');
            return;
        }
        
        if (!isAuthReady || !db || !userId) {
            alertModal('è³‡æ–™åº«å°šæœªå°±ç·’ï¼Œè«‹ç¨å€™ã€‚');
            return;
        }
        
        // é‡è¨­æŠ•å¹£ç‹€æ…‹
        hasCoin = false;
        knobButton.disabled = true;
        
        // ç”±æ–¼å·²ç¶“åœ¨ insertCoin() ä¸­è™•ç†äº† coinButton çš„ç¦ç”¨å’Œé¡è‰²ï¼Œé€™è£¡åªéœ€ä¿æŒç¦ç”¨å³å¯ã€‚
        coinStatus.textContent = 'æŠ•å…¥é‡‘å¹£'; // æ–‡å­—å¾©åŸ
        
        // å•Ÿç”¨è½‰å‹•å‹•ç•«
        knob.classList.add('knob-turning-full'); 
        machineStatus.textContent = 'æŠ½å–ä¸­... (è«‹ç­‰å¾…)';
        loadingSpinner.classList.remove('hidden');
        playSFX('turn'); 
        
        // 1. éš¨æ©ŸæŠ½å–ä¸€å€‹çå“ (åŠ å…¥å½©è›‹æ©Ÿç‡åˆ¤å®š)
        let newPrize;
        const kinderJoyPrize = prizes.find(p => p.id === 7); // å½©è›‹
        const regularPrizes = prizes.filter(p => p.id !== 7); // å¸¸è¦çå“
        const RARE_CHANCE = 0.08; // 8% æ©Ÿç‡

        if (Math.random() < RARE_CHANCE) {
            newPrize = kinderJoyPrize; // æŠ½åˆ°å½©è›‹
        } else {
            // æŠ½åˆ°å¸¸è¦çå“
            const randomIndex = Math.floor(Math.random() * regularPrizes.length);
            newPrize = regularPrizes[randomIndex];
        }

        const prizeData = { id: newPrize.id, timestamp: new Date().toISOString() };
        currentPrize = newPrize; 

        // 2. éš¨æ©Ÿç”¢ç”Ÿè† å›Šçƒçš„å‚¾æ–œè§’åº¦
        const randomRotation = Math.floor(Math.random() * 91) - 45; // -45åº¦ åˆ° +45åº¦

        // 3. è¦–è¦ºç§»é™¤ä¸€å€‹çƒæ± ä¸­çš„è† å›Šçƒ
        const currentCapsules = capsulePoolEl.querySelectorAll('.capsule');
        if (currentCapsules.length > 0) {
            // å˜—è©¦ç§»é™¤ä¸€å€‹é¡è‰²èˆ‡ä¸­ççå“åŸºç¤è‰²ç›¸ä¼¼çš„çƒï¼Œè®“è¦–è¦ºæ›´é€£è²«
            let capsuleToRemove = Array.from(currentCapsules).find(c => c.style.backgroundColor.includes(currentPrize.base_color));

            // å¦‚æœæ²’æœ‰ç›¸ä¼¼é¡è‰²çš„ï¼Œå‰‡éš¨æ©Ÿé¸ä¸€å€‹ç§»é™¤
            if (!capsuleToRemove) {
                const randomCapsuleIndex = Math.floor(Math.random() * currentCapsules.length);
                capsuleToRemove = currentCapsules[randomCapsuleIndex];
            }
            
            // æ¨¡æ“¬çƒè¢«æŠ½èµ°å¾Œå‘ä¸‹æ»¾è½ä¸¦æ·¡å‡ºçš„æ•ˆæœ
            capsuleToRemove.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
            capsuleToRemove.style.transform = `translateY(150px) scale(0.1) rotate(${Math.random() * 360}deg)`; 
            capsuleToRemove.style.opacity = '0';
            
            // ç§»é™¤è³‡æ–™ä¸­çš„è† å›Šçƒ
            // ç”±æ–¼ capsulePoolData ä¸­çš„æ•¸æ“šè¼ƒç‚ºéœæ…‹ï¼Œæˆ‘å€‘åœ¨é€™è£¡ç›´æ¥åœ¨ UI ç§»é™¤ä¸¦æ›´æ–° data
            const indexToRemove = Array.from(currentCapsules).findIndex(c => c === capsuleToRemove);
            if(indexToRemove !== -1) {
                 capsulePoolData.splice(indexToRemove, 1);
            }
            
            // å»¶é² 500ms è®“é¸ä¸­çš„çƒè½ä¸‹çš„å‹•ç•«å®Œæˆ
            setTimeout(() => {
                capsuleToRemove.remove();
                
                // === é—œéµä¿®æ­£ï¼šå¾®èª¿æ‰€æœ‰å‰©é¤˜è† å›Šçš„ä½ç½®ï¼Œæ¨¡æ“¬é‡åŠ›æ²‰é™å’Œæ°´å¹³ä½ç§» ===
                const percentageAdjustment = 1.2; // 1.2% for vertical sink
                const horizontalJiggle = 2; // max 2% horizontal shift

                capsulePoolData.forEach(data => {
                    if (typeof data.top === 'number' && typeof data.left === 'number') {
                        // 1. å‚ç›´æ²‰é™ (å‘ä¸‹ç§»å‹• 1.2%)
                        data.top = Math.min(95, data.top + percentageAdjustment);

                        // 2. æ°´å¹³å¡«è£œç©ºéš™ (éš¨æ©Ÿå·¦å³ç§»å‹• -2% åˆ° +2%)
                        const jiggle = (Math.random() - 0.5) * horizontalJiggle; // -1 to +1, multiplied by 2 -> -2 to +2
                        data.left = data.left + jiggle;

                        // ç¢ºä¿ left ç•™åœ¨ç¯„åœå…§
                        data.left = Math.max(0, Math.min(95, data.left));
                    }
                });
                renderCapsulePool(); 
                // ===================================================

            }, 500); 
        }

        // 4. å„²å­˜çå“åˆ° Firestore
        try {
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'urology_gacha', 'prizes');
            // ä½¿ç”¨ arrayUnion å˜—è©¦æ›´æ–°ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‰‡æœƒé€²å…¥ catch å€å¡Š
            await updateDoc(userDocRef, { collectedPrizes: arrayUnion(prizeData) });
        } catch (error) {
            // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ (ç¬¬ä¸€æ¬¡æŠ½ç)ï¼Œå‰‡å‰µå»ºæ–°æ–‡ä»¶
            if (error.code === 'not-found') {
                try {
                     await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'urology_gacha', 'prizes'), {
                        userId: userId,
                        collectedPrizes: [prizeData]
                    });
                } catch (createError) {
                    console.error("é¦–æ¬¡å‰µå»ºæ–‡ä»¶å¤±æ•—:", createError);
                    alertModal("éŒ¯èª¤ï¼šç„¡æ³•å„²å­˜æ‚¨çš„çå“ã€‚");
                }
            } else {
                console.error("æŠ½çæ™‚ç™¼ç”Ÿ Firestore éŒ¯èª¤:", error);
                alertModal("éŒ¯èª¤ï¼šæŠ½çæ™‚ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ã€‚");
            }
        }

        // 5. UI å»¶é²ï¼šç­‰å¾… 1.5s å‹•ç•«çµæŸå¾Œï¼Œè† å›Šçƒæ‰å‡ºç¾
        setTimeout(() => {
            knob.classList.remove('knob-turning-full'); 
            
            // è† å›Šçƒå‡ºç¾ä¸¦ç­‰å¾…æ‹¿å–
            machineStatus.textContent = 'è«‹é»æ“Šè† å›Šçƒæ‹¿å–çå“ï¼';
            loadingSpinner.classList.add('hidden');
            
            // è¨­ç½®è† å›Šçƒæ¨£å¼å’Œéš¨æ©Ÿæ—‹è½‰
            prizeChute.className = `capsule-in-chute flex items-center justify-center text-3xl font-bold prize-out text-white transition`;
            prizeChute.style.backgroundColor = currentPrize.base_color; 
            prizeChute.style.transform = `rotate(${randomRotation}deg)`; // æ‡‰ç”¨éš¨æ©Ÿå‚¾æ–œ
            prizeChute.textContent = currentPrize.icon;
            prizeChute.disabled = false;
            prizeChute.onclick = window.collectPrize; 
            
            playSFX('drop'); 
        }, 1500); 
    }

    /**
     * é¡¯ç¤ºæœ€æ–°æŠ½ççµæœ
     */
    function showLatestPrizeContent(prize) {
        latestPrizeDisplay.innerHTML = `
            <div class="flex items-center mb-2">
                <span class="text-4xl mr-3" style="color: ${prize.base_color};">${prize.icon}</span>
                <p class="text-xl font-bold text-gray-800">${prize.name} ${prize.id === 7 ? '<span class="text-sm text-pink-600 font-bold ml-1">(å½©è›‹)</span>' : ''}</p>
            </div>
            <p class="text-sm text-gray-600">${prize.description}</p>
        `;
    }

    /**
     * è™•ç†é»æ“Šè† å›Šçƒ (æ‹¿å–) äº‹ä»¶
     */
    window.collectPrize = function() {
        if (!currentPrize) return;

        // 1. é¡¯ç¤ºçå“å…§å®¹
        showLatestPrizeContent(currentPrize);
        
        // 2. æ¨¡æ“¬æ‹¿èµ°æ•ˆæœ
        prizeChute.classList.add('scale-0', 'opacity-0'); 
        
        // å»¶é²é‡è¨­ UI
        setTimeout(() => {
            // æ¢å¾©ç‚ºå‡¹æ§½çš„é è¨­å¤–è§€
            prizeChute.className = 'w-[70px] h-[70px] bg-[#374151] rounded-[10px] border-2 border-[#555] flex justify-center items-center transition';
            prizeChute.style.backgroundColor = ''; 
            prizeChute.style.transform = ''; // æ¸…é™¤æ—‹è½‰
            prizeChute.textContent = ''; 
            prizeChute.disabled = true;
            prizeChute.onclick = null;
            currentPrize = null;
            
            // æç¤ºä½¿ç”¨è€…æŠ•å¹£
            machineStatus.textContent = 'è«‹æŠ•å…¥é‡‘å¹£ (1/1)';
            knobButton.disabled = true;
            
            // é‡æ–°å•Ÿç”¨æŠ•å¹£å£ä¸¦é–‹å§‹é–ƒçˆ
            coinButton.disabled = false;
            coinButton.classList.add('coin-ready-flash');
            
        }, 500); // è®“ scale-0, opacity-0 çš„éæ¸¡æœ‰æ™‚é–“å®Œæˆ
    }

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    window.onload = function () {
        renderCapsulePool(); // ç¹ªè£½åˆå§‹è† å›Šçƒ
        initFirebase(); // å•Ÿå‹• Firebase
        
        // åˆå§‹ç‹€æ…‹ï¼šæŠ•å¹£å£æ‡‰è©²é–ƒçˆ
        coinButton.classList.add('coin-ready-flash');
    }

</script>

